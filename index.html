<!DOCTYPE html>
<html lang="uk">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>–ù–µ–π—Ä–æ-–ú–µ—Ç–∞–±–æ–ª—ñ—á–Ω–∏–π –¢—Ä–µ–∫–µ—Ä</title>
  <style>
    body{font-family:'Segoe UI',Tahoma,Geneva,Verdana,sans-serif;background:#f4f7f6;color:#333;margin:0;padding:20px;display:flex;flex-direction:column;align-items:center}
    .container{background:#fff;padding:30px;border-radius:12px;box-shadow:0 6px 15px rgba(0,0,0,.1);max-width:900px;width:100%}
    h1{color:#007bff;text-align:center;margin-bottom:25px;border-bottom:2px solid #007bff;padding-bottom:10px}
    .upload-section{background:#e7f3ff;padding:20px;border-radius:8px;margin-bottom:20px;border:2px dashed #007bff}
    .upload-btn{
      background:#007bff;
      color:#fff;
      border:none;
      padding:10px 20px;
      border-radius:6px;
      cursor:pointer;
      font-size:1em;
      margin-right:10px;
      transition:background-color .3s;
    }
    .upload-btn:hover{background:#0056b3}
    .file-name{margin-left:10px;font-style:italic}
    .two{display:grid;grid-template-columns:1fr 1fr;gap:14px}
    @media(max-width:760px){.two{grid-template-columns:1fr}}
    .metrics-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(280px,1fr));gap:20px;margin-bottom:18px}
    .metric-card{padding:15px;border-radius:8px;background:#f9f9f9;border-left:5px solid #ccc;transition:all .3s ease}
    .metric-card h3{margin-top:0;color:#555;font-size:1.05em;display:flex;justify-content:space-between;gap:8px}
    .metric-card .value{font-size:1.6em;font-weight:700;color:#333}
    .status{font-weight:700;padding:5px 10px;border-radius:5px;font-size:.9em;display:inline-block;margin-top:10px}
    .status.normal{background:#d4edda;color:#155724}
    .status.alert{background:#f8d7da;color:#721c24}
    .prognosis-box{background:#e9ecef;padding:20px;border-radius:8px;margin-top:18px;border-left:8px solid #007bff}
    .prognosis-box h2{color:#007bff;margin-top:0}
    .actions{text-align:center;margin-top:18px;display:flex;flex-wrap:wrap;gap:10px;justify-content:center}
    .download-btn{background:#28a745;color:#fff;border:none;padding:10px 20px;border-radius:6px;cursor:pointer;font-size:1em;transition:background-color .3s}
    .download-btn:hover{background:#218838}
    .primary-btn{background:#007bff;color:#fff;border:none;padding:10px 20px;border-radius:6px;cursor:pointer;font-size:1em;transition:background-color .3s}
    .primary-btn:hover{background:#0056b3}
    .secondary-btn{background:#6c757d;color:#fff;border:none;padding:10px 20px;border-radius:6px;cursor:pointer;font-size:1em;transition:background-color .3s}
    .secondary-btn:hover{background:#545b62}
    .note{font-size:.9em;color:#777;margin-top:20px;text-align:center}
    .range-text{font-size:.8em;color:#777}
    .hidden{display:none}
    .file-header {grid-column: 1 / -1; border-bottom: 2px solid #ddd; margin-top: 20px; padding-bottom: 5px; color: #555; font-weight: bold;}
  </style>
  <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@4.18.0/dist/tf.min.js"></script>
</head>
<body>
  <div class="container">
    <h1>üî¨ –ù–µ–π—Ä–æ-–ú–µ—Ç–∞–±–æ–ª—ñ—á–Ω–∏–π –¢—Ä–µ–∫–µ—Ä</h1>

    <div class="upload-section">
      <h3>üìÅ –ó–∞–≤–∞–Ω—Ç–∞–∂—Ç–µ JSON –∑ 4 –ø–æ–∫–∞–∑–Ω–∏–∫–∞–º–∏</h3>
      <div class="two">
        <div>
          <button class="upload-btn" onclick="document.getElementById('train-input').click()">üìÇ –í–∏–±—Ä–∞—Ç–∏ –Ω–∞–≤—á–∞–ª—å–Ω—ñ JSON (–º–æ–∂–Ω–∞ –∫—ñ–ª—å–∫–∞)</button>
          <input id="train-input" type="file" accept=".json" multiple class="hidden">
          <div id="train-name" class="file-name">–ù–∞–≤—á–∞–ª—å–Ω—ñ —Ñ–∞–π–ª–∏: –Ω–µ –æ–±—Ä–∞–Ω–æ</div>
        </div>
        <div>
          <button class="upload-btn" onclick="document.getElementById('infer-input').click()">üìÇ –í–∏–±—Ä–∞—Ç–∏ –ø–æ—Ç–æ—á–Ω–∏–π JSON</button>
          <input id="infer-input" type="file" accept=".json" class="hidden">
          <div id="infer-name" class="file-name">–ü–æ—Ç–æ—á–Ω–∏–π —Ñ–∞–π–ª: –Ω–µ –æ–±—Ä–∞–Ω–æ</div>
        </div>
      </div>
      <p style="margin-top:10px;font-size:.9em;color:#666">
        –ö–ª—é—á—ñ: heart_rate_resting_bpm, hrv_rmssd_ms, lactate_baseline_mmol_l, eeg_alpha_theta_ratio
      </p>
    </div>

    <div id="analysis-section" class="hidden">
      <h2>üìä –ü–æ—Ç–æ—á–Ω—ñ –ø–æ–∫–∞–∑–Ω–∏–∫–∏ —Ç–∞ –∞–Ω–∞–ª—ñ–∑</h2>
      <div id="metrics-output" class="metrics-grid"></div>

      <div class="prognosis-box">
        <h2>üîÆ –®–Ü: –Ω–æ—Ä–º–∞ / —Ä–∏–∑–∏–∫ (0 –∞–±–æ 1)</h2>
        <p id="prognosis-text">–û—á—ñ–∫—É–≤–∞–Ω–Ω—è –¥–∞–Ω–∏—Ö...</p>
      </div>

      <div class="actions">
        <button class="primary-btn" id="btn-train">‚öôÔ∏è –ù–∞–≤—á–∏—Ç–∏ –®–Ü</button>
        <button class="secondary-btn" id="btn-predict" disabled>‚ñ∂Ô∏è –ü—Ä–æ–≥–Ω–æ–∑ (–ø–æ—Ç–æ—á–Ω–∏–π –∑–∞–º—ñ—Ä)</button>
        <button class="download-btn" id="btn-download" disabled>‚¨áÔ∏è –ó–∞–≤–∞–Ω—Ç–∞–∂–∏—Ç–∏ –∑–≤—ñ—Ç JSON</button>
      </div>
    </div>

    <p class="note">–†–µ–∑—É–ª—å—Ç–∞—Ç –®–Ü —î —ñ–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–æ–º —ñ–Ω–¥–∏–∫–∞—Ü—ñ—ó —Ç–∞ –Ω–µ –∑–∞–º—ñ–Ω—é—î –º–µ–¥–∏—á–Ω—É –æ—Ü—ñ–Ω–∫—É.</p>
  </div>

  <script>
    let trainFiles = []
    let inferFile = null
    let trainSet = null
    let norm = null
    let model = null
    let threshold = null
    let lastReport = null

    const BASELINE_DATA = {
      heart_rate_resting_bpm: { avg: 55, sd: 5, unit: "—É–¥/—Ö–≤", title: "–ü—É–ª—å—Å —Å–ø–æ–∫–æ—é (–ß–°–°)" },
      hrv_rmssd_ms: { avg: 45, sd: 10, unit: "–º—Å", title: "–í–°–† (RMSSD)" },
      lactate_baseline_mmol_l: { avg: 0.8, sd: 0.2, unit: "–º–º–æ–ª—å/–ª", title: "–ë–∞–∑–æ–≤–∏–π –ª–∞–∫—Ç–∞—Ç" },
      eeg_alpha_theta_ratio: { avg: 3.0, sd: 0.5, unit: "—Å–ø—ñ–≤–≤—ñ–¥–Ω–æ—à–µ–Ω–Ω—è", title: "EEG: –∞–ª—å—Ñ–∞/—Ç–µ—Ç–∞" }
    }

    const $ = (id) => document.getElementById(id)

    function toVector(obj) {
      return [
        obj.heart_rate_resting_bpm,
        obj.hrv_rmssd_ms,
        obj.lactate_baseline_mmol_l,
        obj.eeg_alpha_theta_ratio
      ]
    }

    function validateObj(obj) {
      const keys = ["heart_rate_resting_bpm", "hrv_rmssd_ms", "lactate_baseline_mmol_l", "eeg_alpha_theta_ratio"]
      for (const k of keys) {
        if (!(k in obj)) return false
        if (typeof obj[k] !== "number" || !Number.isFinite(obj[k])) return false
      }
      return true
    }

    function readJsonFile(file) {
      return new Promise((resolve, reject) => {
        const r = new FileReader()
        r.onload = () => {
          try {
            const obj = JSON.parse(r.result)
            if (!validateObj(obj)) return reject(new Error("invalid"))
            resolve(obj)
          } catch {
            reject(new Error("parse"))
          }
        }
        r.onerror = () => reject(new Error("read"))
        r.readAsText(file)
      })
    }

    function renderMetrics(obj, title = null) {
      const out = $("metrics-output")
      
      if (title) {
        out.innerHTML += `<div class="file-header">${title}</div>`
      }

      for (const key of Object.keys(BASELINE_DATA)) {
        const base = BASELINE_DATA[key]
        const current = obj[key]
        const lower = base.avg - base.sd * 1.5
        const upper = base.avg + base.sd * 1.5
        const inRange = current >= lower && current <= upper
        const status = inRange ? "‚úÖ –í –ù–û–†–ú–Ü" : (current > upper ? "‚ùå –ü–û–ó–ê –ù–û–†–ú–û–Æ (–í–ò–©–ï)" : "‚ùå –ü–û–ó–ê –ù–û–†–ú–û–Æ (–ù–ò–ñ–ß–ï)")
        const statusClass = inRange ? "normal" : "alert"
        out.innerHTML += `<div class="metric-card"><h3>${base.title}</h3><div class="value">${current.toFixed(2)} ${base.unit}</div><div class="range-text">–ù–æ—Ä–º–∞: ${lower.toFixed(2)} - ${upper.toFixed(2)} ${base.unit}</div><div class="status ${statusClass}">${status}</div></div>`
      }
    }

    function buildModel() {
      const m = tf.sequential()
      m.add(tf.layers.dense({ units: 8, activation: "relu", inputShape: [4] }))
      m.add(tf.layers.dense({ units: 3, activation: "relu" }))
      m.add(tf.layers.dense({ units: 8, activation: "relu" }))
      m.add(tf.layers.dense({ units: 4, activation: "linear" }))
      m.compile({ optimizer: tf.train.adam(0.01), loss: "meanSquaredError" })
      return m
    }

    function computeNorm(xArr) {
      const x = tf.tensor2d(xArr)
      const mean = x.mean(0)
      const std = x.sub(mean).square().mean(0).sqrt()
      return { mean, std }
    }

    function normalize(xArr, n) {
      const x = tf.tensor2d(xArr)
      const stdSafe = n.std.add(tf.scalar(1e-6))
      const z = x.sub(n.mean).div(stdSafe)
      return z
    }

    async function train() {
      if (!trainSet || trainSet.length < 2) return { ok: false, msg: "–ü–æ—Ç—Ä—ñ–±–Ω–æ –º—ñ–Ω—ñ–º—É–º 2 –Ω–∞–≤—á–∞–ª—å–Ω—ñ JSON" }
      if (model) model.dispose()
      if (norm) { norm.mean.dispose(); norm.std.dispose() }
      norm = computeNorm(trainSet)
      model = buildModel()
      const z = normalize(trainSet, norm)
      await model.fit(z, z, { epochs: 80, batchSize: Math.min(4, trainSet.length), shuffle: true })
      const errs = await reconstructionErrors(trainSet)
      const mu = mean(errs)
      const sigma = std(errs, mu)
      threshold = mu + 2 * sigma
      return { ok: true, msg: "–ù–∞–≤—á–∞–Ω–Ω—è –∑–∞–≤–µ—Ä—à–µ–Ω–æ" }
    }

    async function reconstructionErrors(xArr) {
      const z = normalize(xArr, norm)
      const pred = model.predict(z)
      const err = tf.mean(tf.square(tf.sub(z, pred)), 1)
      const arr = await err.data()
      z.dispose()
      pred.dispose()
      err.dispose()
      return Array.from(arr)
    }

    function mean(a) {
      if (a.length === 0) return 0
      return a.reduce((s, v) => s + v, 0) / a.length
    }

    function std(a, mu) {
      if (a.length === 0) return 0
      const m = mu ?? mean(a)
      const v = a.reduce((s, x) => s + (x - m) * (x - m), 0) / a.length
      return Math.sqrt(v)
    }

    async function predict(obj) {
      if (!model || !norm || threshold === null) return { ok: false, msg: "–°–ø–æ—á–∞—Ç–∫—É –Ω–∞–≤—á—ñ—Ç—å –®–Ü" }
      const x = [toVector(obj)]
      const z = normalize(x, norm)
      const pred = model.predict(z)
      const err = tf.mean(tf.square(tf.sub(z, pred)), 1)
      const e = (await err.data())[0]
      const cls = e > threshold ? 1 : 0
      z.dispose()
      pred.dispose()
      err.dispose()
      return { ok: true, err: e, cls: cls }
    }

    function makeReport(raw, pred) {
      return {
        timestamp: new Date().toISOString(),
        input: raw,
        model: { type: "autoencoder", feature_count: 4, threshold: threshold },
        output: { class_0_1: pred.cls, reconstruction_error: pred.err }
      }
    }

    function downloadJson(obj) {
      const blob = new Blob([JSON.stringify(obj, null, 2)], { type: "application/json" })
      const url = URL.createObjectURL(blob)
      const a = document.createElement("a")
      a.href = url
      a.download = "analysis_report.json"
      document.body.appendChild(a)
      a.click()
      a.remove()
      URL.revokeObjectURL(url)
    }

    $("train-input").addEventListener("change", async (e) => {
      trainFiles = Array.from(e.target.files || [])
      $("train-name").textContent = trainFiles.length ? `–ù–∞–≤—á–∞–ª—å–Ω—ñ —Ñ–∞–π–ª–∏: ${trainFiles.length} —à—Ç.` : "–ù–∞–≤—á–∞–ª—å–Ω—ñ —Ñ–∞–π–ª–∏: –Ω–µ –æ–±—Ä–∞–Ω–æ"
      if (trainFiles.length === 0) return

      const promises = trainFiles.map(f => readJsonFile(f).catch(err => null))
      const objs = (await Promise.all(promises)).filter(x => x !== null)

      if (objs.length === 0) {
        alert("–ñ–æ–¥–µ–Ω —Ñ–∞–π–ª –Ω–µ –≤–∞–ª—ñ–¥–Ω–∏–π!")
        trainSet = null
        return
      }

      trainSet = objs.map(obj => toVector(obj))
      $("analysis-section").classList.remove("hidden")
      
      $("metrics-output").innerHTML = ""
      
      objs.forEach((obj, index) => {
        renderMetrics(obj, `–§–∞–π–ª ‚Ññ${index + 1} (${trainFiles[index].name})`)
      })
    })

    $("infer-input").addEventListener("change", async (e) => {
      inferFile = e.target.files?.[0] || null
      $("infer-name").textContent = inferFile ? `–ü–æ—Ç–æ—á–Ω–∏–π —Ñ–∞–π–ª: ${inferFile.name}` : "–ü–æ—Ç–æ—á–Ω–∏–π —Ñ–∞–π–ª: –Ω–µ –æ–±—Ä–∞–Ω–æ"
      if (!inferFile) return
      try {
        const obj = await readJsonFile(inferFile)
        $("analysis-section").classList.remove("hidden")
        
        $("metrics-output").innerHTML = ""
        renderMetrics(obj, "–ü–æ—Ç–æ—á–Ω–∏–π –∑–∞–º—ñ—Ä")
        
        $("prognosis-text").textContent = "–ü—ñ—Å–ª—è –Ω–∞–≤—á–∞–Ω–Ω—è –Ω–∞—Ç–∏—Å–Ω–∏ ¬´–ü—Ä–æ–≥–Ω–æ–∑ (–ø–æ—Ç–æ—á–Ω–∏–π –∑–∞–º—ñ—Ä)¬ª."
      } catch {
        $("analysis-section").classList.add("hidden")
      }
    })

    $("btn-train").addEventListener("click", async () => {
      const r = await train()
      $("prognosis-text").textContent = r.msg
      $("btn-predict").disabled = !(r.ok)
      $("btn-download").disabled = true
    })

    $("btn-predict").addEventListener("click", async () => {
      if (!inferFile) return
      try {
        const obj = await readJsonFile(inferFile)
        const p = await predict(obj)
        if (!p.ok) {
          $("prognosis-text").textContent = p.msg
          return
        }
        const text = p.cls === 0 ? "–†–µ–∑—É–ª—å—Ç–∞—Ç: 0 (–Ω–æ—Ä–º–∞). –†–∏–∑–∏–∫ –Ω–µ –ø—ñ–¥–≤–∏—â–µ–Ω–∏–π." : "–†–µ–∑—É–ª—å—Ç–∞—Ç: 1 (—Ä–∏–∑–∏–∫). –ü–æ–∫–∞–∑–Ω–∏–∫–∏ –≤—ñ–¥—Ö–∏–ª—è—é—Ç—å—Å—è –≤—ñ–¥ –∑–≤–∏—á–Ω–æ–≥–æ –ø–∞—Ç–µ—Ä–Ω—É."
        $("prognosis-text").textContent = text
        lastReport = makeReport(obj, p)
        $("btn-download").disabled = false
      } catch {
        $("prognosis-text").textContent = "–ù–µ –≤–¥–∞–ª–æ—Å—è –æ–±—Ä–æ–±–∏—Ç–∏ –ø–æ—Ç–æ—á–Ω–∏–π JSON."
      }
    })

    $("btn-download").addEventListener("click", () => {
      if (lastReport) downloadJson(lastReport)
    })
  </script>
</body>
</html>